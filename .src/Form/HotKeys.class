' Gambas class file

'Copyright (C) 2007, 2008 Antonio Orefice
' Gambas class file

Public xbindkeys As Process
Public AlreadyLoaded As Boolean = False 'true if the form loaded it's settings from disk at least one time

Public Sub xbindkeys_read()
  Dim comando As String
  Line Input #xbindkeys, comando
    Debug "Remote Command = " & comando
    Debug
    Select Case comando
      Case "Start play"
        FMain.ButtonStop_Click()
        FMain.ButtonPlay_Click()
      Case "Play/Pause"
        'IF NOT FMain.mplayer.ProcessRunningOvr() THEN FMain.ButtonPlay_Click()
        FMain.ButtonPlay_Click()
      Case "Stop"
        FMain.ButtonStop_Click()
      Case "Next Track"
        FMain.SelectNext(False, FMain.GetActivePlayQueue())
      Case "Previous Track"
        FMain.ButtonPrev_Click()
      Case "Seek +10sec"
        FMain.mplayer.Send("Seek +10")
      Case "Seek -10sec"
        FMain.mplayer.Send("Seek -10")
      Case "Volume +"
        FMain.SaveVolumeSlider.value = FMain.SaveVolumeSlider.value + 1
      Case "Volume -"
        FMain.SaveVolumeSlider.value = FMain.SaveVolumeSlider.value - 1
      Case "Mute/UnMute"
        FMain.mplayer.Send("mute")
    End Select
End


Private Sub FillGridHeaders()
  Dim r, c As Integer
  
  'Local Hotkeys#####################################
  HotKeysGrid.Columns.count = 5
  HotKeysGrid.rows.count = 92
  HotKeysGrid.Columns[0].text = "HotKey 1"
  HotKeysGrid.Columns[1].text = "HotKey 2"
  HotKeysGrid.Columns[2].text = "HotKey 3"
  HotKeysGrid.Columns[3].text = "HotKey 4"
  HotKeysGrid.Columns[4].text = "HotKey 5"
  HotKeysGrid.Rows[0].text = "Vo_fullscreen"
  HotKeysGrid.Rows[1].text = "Pause"
  HotKeysGrid.Rows[2].text = "Mute"
  HotKeysGrid.Rows[3].text = "Volume +0.5"
  HotKeysGrid.Rows[4].text = "Volume -0.5"
  HotKeysGrid.Rows[5].text = "Seek +10"
  HotKeysGrid.Rows[6].text = "Seek -10"
  HotKeysGrid.Rows[7].text = "Seek +60"
  HotKeysGrid.Rows[8].text = "Seek -60"
  HotKeysGrid.Rows[9].text = "Seek +600"
  HotKeysGrid.Rows[10].text = "Seek -600"
  HotKeysGrid.Rows[11].text = "Panscan +0.05"
  HotKeysGrid.Rows[12].text = "Panscan -0.05"
  HotKeysGrid.Rows[13].text = "Osd"
  HotKeysGrid.Rows[14].text = "Switch_audio"
  HotKeysGrid.Rows[15].text = "Sub_select"
  HotKeysGrid.Rows[16].text = "Screenshot"
  HotKeysGrid.Rows[17].text = "Audio_delay +0.1"
  HotKeysGrid.Rows[18].text = "Audio_delay -0.1"
  HotKeysGrid.Rows[19].text = "Sub_delay +0.1"
  HotKeysGrid.Rows[20].text = "Sub_delay -0.1"
  HotKeysGrid.Rows[21].text = "Sub_scale +0.1"
  HotKeysGrid.Rows[22].text = "Sub_scale -0.1"
  HotKeysGrid.Rows[23].text = "Speed_incr +0.01"
  HotKeysGrid.Rows[24].text = "Speed_incr -0.01"
  HotKeysGrid.Rows[25].text = "Balance +0.1"
  HotKeysGrid.Rows[26].text = "Balance -0.1"
  HotKeysGrid.Rows[27].text = "Contrast +1"
  HotKeysGrid.Rows[28].text = "Contrast -1"
  HotKeysGrid.Rows[29].text = "Gamma +1"
  HotKeysGrid.Rows[30].text = "Gamma -1"
  HotKeysGrid.Rows[31].text = "Brightness +1"
  HotKeysGrid.Rows[32].text = "Brightness -1"
  HotKeysGrid.Rows[33].text = "Hue +1"
  HotKeysGrid.Rows[34].text = "Hue -1"
  HotKeysGrid.Rows[35].text = "Saturation +1"
  HotKeysGrid.Rows[36].text = "Saturation -1"
  HotKeysGrid.Rows[37].text = "Exit"
  HotKeysGrid.Rows[38].text = "edl_mark"
  HotKeysGrid.Rows[39].text = "speed_mult 1.1"
  HotKeysGrid.Rows[40].text = "speed_mult 0.9"
  HotKeysGrid.Rows[41].text = "speed_set 1"
  HotKeysGrid.Rows[42].text = "quit"
  HotKeysGrid.Rows[43].text = "frame_step"
  HotKeysGrid.Rows[44].text = "radio_step_channel 1"
  HotKeysGrid.Rows[45].text = "radio_step_channel -1"
  HotKeysGrid.Rows[46].text = "use_master"
  HotKeysGrid.Rows[47].text = "frame_drop"
  HotKeysGrid.Rows[48].text = "sub_pos +5"
  HotKeysGrid.Rows[49].text = "sub_pos -5"
  HotKeysGrid.Rows[50].text = "sub_alignment"
  HotKeysGrid.Rows[51].text = "sub_visibility"
  HotKeysGrid.Rows[52].text = "sub_load"
  HotKeysGrid.Rows[53].text = "tv_start_scan"
  HotKeysGrid.Rows[54].text = "tv_step_channel +1"
  HotKeysGrid.Rows[55].text = "tv_step_channel -1"
  HotKeysGrid.Rows[56].text = "tv_step_norm"
  HotKeysGrid.Rows[57].text = "switch_ratio"
  HotKeysGrid.Rows[58].text = "tv_set_brightness +5"
  HotKeysGrid.Rows[59].text = "tv_set_brightness -5"
  HotKeysGrid.Rows[60].text = "tv_set_contrast +5"
  HotKeysGrid.Rows[61].text = "tv_set_contrast -5"
  HotKeysGrid.Rows[62].text = "tv_set_hue +5"
  HotKeysGrid.Rows[63].text = "tv_set_hue -5"
  HotKeysGrid.Rows[64].text = "tv_set_saturation +5"
  HotKeysGrid.Rows[65].text = "tv_set_saturation -5"
  HotKeysGrid.Rows[66].text = "vo_ontop"
  HotKeysGrid.Rows[67].text = "vo_rootwin"
  HotKeysGrid.Rows[68].text = "vo_border"
  HotKeysGrid.Rows[69].text = "switch_vsync"
  HotKeysGrid.Rows[70].text = "seek_chapter +1"
  HotKeysGrid.Rows[71].text = "seek_chapter -1"
  HotKeysGrid.Rows[72].text = "quit"
  HotKeysGrid.Rows[73].text = "dvdnav up"
  HotKeysGrid.Rows[74].text = "dvdnav down"
  HotKeysGrid.Rows[75].text = "dvdnav left"
  HotKeysGrid.Rows[76].text = "dvdnav right"
  HotKeysGrid.Rows[77].text = "dvdnav menu"
  HotKeysGrid.Rows[78].text = "dvdnav select"
  HotKeysGrid.Rows[79].text = "dvdnav prev"
  HotKeysGrid.Rows[80].text = "dvdnav mouse"
  HotKeysGrid.Rows[81].text = "deinterlace"
  HotKeysGrid.Rows[82].text = "delete current file"


  For r = 83 To HotKeysGrid.Rows.count - 1
    HotKeysGrid.Rows[r].text = "For future use"
  Next 'r
  
  For r = 0 To HotKeysGrid.Rows.count - 1
    If r Mod 2 = 0 Then
      For c = 0 To HotKeysGrid.Columns.count - 1
        HotKeysGrid[r, c].background = Global.Alternatecolor
      Next 'c
    Endif
  Next 'r
  
 
  
  'Global Hotkeys #######################################################
  
  GlobalHotKeysGrid.Columns.count = 5
  GlobalHotKeysGrid.rows.count = 20
  GlobalHotKeysGrid.Columns[0].text = "HotKey 1"
  GlobalHotKeysGrid.Columns[1].text = "HotKey 2"
  GlobalHotKeysGrid.Columns[2].text = "HotKey 3"
  GlobalHotKeysGrid.Columns[3].text = "HotKey 4"
  GlobalHotKeysGrid.Columns[4].text = "HotKey 5"
  
  GlobalHotKeysGrid.Rows[0].text = "Start play"
  GlobalHotKeysGrid.Rows[1].text = "Play/Pause"
  GlobalHotKeysGrid.Rows[2].text = "Stop"
  GlobalHotKeysGrid.Rows[3].text = "Next Track"
  GlobalHotKeysGrid.Rows[4].text = "Previous Track"
  GlobalHotKeysGrid.Rows[5].text = "Seek +10sec"
  GlobalHotKeysGrid.Rows[6].text = "Seek -10sec"
  GlobalHotKeysGrid.Rows[7].text = "Volume +"
  GlobalHotKeysGrid.Rows[8].text = "Volume -"
  GlobalHotKeysGrid.Rows[9].text = "Mute/UnMute"

  For r = 10 To GlobalHotKeysGrid.Rows.count - 1
    GlobalHotKeysGrid.Rows[r].text = "For future use"
  Next 'r

  For r = 0 To GlobalHotKeysGrid.Rows.count - 1
    If r Mod 2 = 0 Then
      For c = 0 To GlobalHotKeysGrid.Columns.count - 1
        GlobalHotKeysGrid[r, c].background = Global.Alternatecolor
      Next 'c
    Endif
  Next 'r
  
  
End

Private Sub DefaultFill()
  Dim r, c As Integer
  'clear grid
    For r = 0 To HotKeysGrid.Rows.count - 1
      For c = 0 To HotKeysGrid.Columns.count - 1
        HotKeysGrid[r, c].Text = ""
      Next
    Next
  'fill grid with default values
    HotKeysGrid[0, 0].text = "Mouse=0 Wheel=NONE Key=f"
    HotKeysGrid[0, 1].text = "Mouse=4 Wheel=NONE Key="
    HotKeysGrid[1, 0].text = "Mouse=0 Wheel=NONE Key=p"
    HotKeysGrid[1, 1].text = "Mouse=1 Wheel=NONE Key="
    HotKeysGrid[1, 2].text = "Mouse=0 Wheel=NONE Key=space"
    HotKeysGrid[2, 0].text = "Mouse=0 Wheel=NONE Key=m"
    HotKeysGrid[3, 0].text = "Mouse=0 Wheel=NONE Key=+"
    HotKeysGrid[3, 1].text = "Mouse=0 Wheel=UP Key="
    HotKeysGrid[4, 0].text = "Mouse=0 Wheel=NONE Key=-"
    HotKeysGrid[4, 1].text = "Mouse=0 Wheel=DOWN Key="
    HotKeysGrid[5, 0].text = "Mouse=0 Wheel=NONE Key=right"
    HotKeysGrid[5, 1].text = "Mouse=1 Wheel=UP Key="
    HotKeysGrid[6, 0].text = "Mouse=0 Wheel=NONE Key=left"
    HotKeysGrid[6, 1].text = "Mouse=1 Wheel=DOWN Key="
    HotKeysGrid[7, 0].text = "Mouse=0 Wheel=NONE Key=up"
    HotKeysGrid[7, 1].text = "Mouse=3 Wheel=UP Key="
    HotKeysGrid[8, 0].text = "Mouse=0 Wheel=NONE Key=down"
    HotKeysGrid[8, 1].text = "Mouse=3 Wheel=DOWN Key="
    HotKeysGrid[11, 0].text = "Mouse=0 Wheel=NONE Key=e"
    HotKeysGrid[11, 1].text = "Mouse=2 Wheel=UP Key="
    HotKeysGrid[12, 0].text = "Mouse=0 Wheel=NONE Key=w"
    HotKeysGrid[12, 1].text = "Mouse=2 Wheel=DOWN Key="
    HotKeysGrid[13, 0].text = "Mouse=0 Wheel=NONE Key=o"
    HotKeysGrid[13, 1].text = "Mouse=2 Wheel=NONE Key="
    HotKeysGrid[14, 0].text = "Mouse=0 Wheel=NONE Key=a"
    HotKeysGrid[15, 0].text = "Mouse=0 Wheel=NONE Key=s"
    HotKeysGrid[16, 0].text = "Mouse=0 Wheel=NONE Key=z"
    HotKeysGrid[72, 0].text = "Mouse=0 Wheel=NONE Key=esc"
    
    HotKeysGrid[73, 0].text = "Mouse=0 Wheel=NONE Key=8"
    HotKeysGrid[74, 0].text = "Mouse=0 Wheel=NONE Key=2"
    HotKeysGrid[75, 0].text = "Mouse=0 Wheel=NONE Key=4"
    HotKeysGrid[76, 0].text = "Mouse=0 Wheel=NONE Key=6"
    HotKeysGrid[77, 0].text = "Mouse=0 Wheel=NONE Key=9"
    HotKeysGrid[78, 0].text = "Mouse=0 Wheel=NONE Key=5"
    HotKeysGrid[79, 0].text = "Mouse=0 Wheel=NONE Key=1"
    HotKeysGrid[80, 0].text = "Mouse=0 Wheel=NONE Key=3"
    HotKeysGrid[81, 0].text = "Mouse=0 Wheel=NONE Mod=Shift Key=d"
    HotKeysGrid[82, 0].text = "Mouse=0 Wheel=NONE Key=del"
    
End



Private Function Grab() As String
  HotKeyGrab.show
  'ME.hide
  Repeat
    Wait 0.1
  Until HotKeyGrab.visible = False
  Return HotKeyGrab.AllGrabbedData()
End

Private Function GlobalGrab() As String
  Dim xbindkeys_output As String
  Dim outputS As String[]
  Dim hotkey As String
  Shell "touch /tmp/xbindkeysrc" Wait
  Shell Global.XbindkeysBIN & " -k -f /tmp/xbindkeysrc" To xbindkeys_output
  outputS = Split(xbindkeys_output, "\n", "", True)
  hotkey = Trim(outputS[outputS.count - 1])
  Return hotkey
End




Public Sub init()
  FillGridHeaders()
End

Public Sub FirstLoadIfNeeded()
    If Not AlreadyLoaded Then 
     Alreadyloaded = True
     MenuLoadDefault_Click()
  Endif
End


Public Sub Form_Open()
  FirstLoadIfNeeded()
  Global.Center(Fmain, Me)
  FillGridHeaders()
End

Private Function CheckDuplicate(Hotkey As String, RowSrc As Integer, ColSrc As Integer, MyGrid As Gridview) As Boolean
  Dim C, R As Integer

  Dim FoundDupe As Boolean = False
  Dim DupedFunction As String
  Dim Answer As Integer
  For c = 0 To MyGrid.Columns.Count - 1
    For r = 0 To MyGrid.Rows.Count - 1
      If MyGrid[r, c].text = Hotkey Then
        FoundDupe = True
        Break
      Endif
      If FoundDupe Then Break
    Next 'r
    If FoundDupe Then Break
  Next 'c
  
  If FoundDupe And (Not ((R = RowSrc) And (C = ColSrc))) Then
    DupedFunction = MyGrid.rows[r].Text
    Answer = Message.Warning(("The hotkey you entered is already defined for ") & DupedFunction, ("Delete old "), ("Delete new "), ("Assign nevertheless"))
    Select Case Answer
      Case 1 'delete old
        MyGrid[r, c].text = ""
        Return True
      Case 2 'delete new
        Return False
      Case 3 'Assign nevertheless
        Return True
      Case 0 'No answer
        Return False
    End Select
      Else
    Return True
  Endif
End

Private Function MouseInsideGrid(Librarygrid As Gridview) As Boolean
  With LibraryGrid
   If (Mouse.screeny > .screeny + .Columns.Height + 1) And (Mouse.screeny < .screeny + .clientH + .Columns.Height + 1) Then
     If (Mouse.screenX < .screenx + .ClientW) Then
       Return True
     Endif
   Endif
 End With
 Return False
End

Public Sub HotKeysGrid_DblClick()
  Dim PointedRow As Integer = HotKeysGrid.row
  Dim PointedCol As Integer = HotKeysGrid.Column
  Dim GrabbedData As String
  Dim w1, w2 As Integer = 0

  If MouseInsideGrid(HotKeysGrid) Then
    GrabbedData = Grab()
    'Insert Grabbed Data into a cell, discard if no Data is received (eg: shift pressed)
    If Not (GrabbedData = "Mouse=0 Wheel=NONE Key= **") Then
      If CheckDuplicate(GrabbedData, HotKeysGrid.row, HotKeysGrid.Column, HotKeysGrid) Then
        HotKeysGrid[pointedrow, PointedCol].Text = GrabbedData
      Endif
    Endif
    
    'Expand the column
    w1 = HotKeysGrid.Columns[PointedCol].width
    ' [GB2:FNTW] w2 = HotKeysGrid.Font.TextWidth(HotKeysGrid[pointedrow, PointedCol].Text)
    w2 = HotKeysGrid.Font.TextWidth(HotKeysGrid[pointedrow, PointedCol].Text)
    If w1 < w2 Then
      HotKeysGrid.Columns[PointedCol].width = w2 + 8
    Endif
  Endif
  
End

Public Sub HotKeysGrid_KeyPress()
  Dim PointedRow As Integer = HotKeysGrid.row
  Dim PointedCol As Integer = HotKeysGrid.Column
  If Key.code = Key.delete Then HotKeysGrid[pointedrow, PointedCol].text = ""
End

Public Sub SaveHotKeys(ProfileName As String)
  'DIM filename AS String = ProfileName & "." & "HotKeys.txt"
  Dim filename As String = ProfileName & ".profile/" & "HotKeys.txt"
  Dim globalfilename As String = ProfileName & ".profile/" & "GlobalHotKeys.txt"
  Dim xbindkeysfilename As String = ProfileName & ".profile/" & "xbindkeysrc"
  Dim HotFile As File
  Dim globalhotfile As File
  
  Dim C, R As Integer

  If Not Exist(file.Dir(filename), True) Then
    Try Mkdir File.dir(File.Dir(File.dir(File.Dir(File.Dir(filename)))))
    Try Mkdir File.Dir(File.dir(File.Dir(File.Dir(filename))))
    Try Mkdir File.dir(File.Dir(File.Dir(filename)))
    Try Mkdir File.Dir(File.Dir(filename))
    Try Mkdir File.Dir(filename)
  Endif
  
  'local hotkeys
  HotFile = Open filename For Write Create
  For c = 0 To HotKeysGrid.Columns.Count - 1
    For r = 0 To HotKeysGrid.Rows.Count - 1
      'PRINT c & "," & r
      Write #HotFile, HotKeysGrid[R, C].text As String
    Next 'r
  Next 'c
  Close #HotFile
  
  'global hotkeys
    'xbindkeys configuration file
    UpdateXbindKeysConfigurationFile(ProfileName & ".profile/" & "xbindkeysrc")
    'stringgrid file
    GlobalHotFile = Open Globalfilename For Write Create
    For c = 0 To GlobalHotKeysGrid.Columns.Count - 1
      For r = 0 To GlobalHotKeysGrid.Rows.Count - 1
        'PRINT c & "," & r
        Write #GlobalHotFile, GlobalHotKeysGrid[R, C].text As String
      Next 'r
    Next 'c
    Close #GlobalHotFile
    RestartXbindKeys(xbindkeysfilename)
End

Public Sub UpdateXbindKeysConfigurationFile(xbindkeysfilename As String)
'will "dump" globalhotkeys grid into xbindkeys file format.
 Dim xbindkeysFile As File
 Dim c, r As Integer
    xbindkeysFile = Open xbindkeysfilename For Write Create
    For c = 0 To GlobalHotKeysGrid.Columns.Count - 1
      For r = 0 To GlobalHotKeysGrid.Rows.Count - 1
        If (Trim(GlobalHotKeysGrid[r, c].text) <> "") Then
          Print #xbindkeysFile, " \"echo '" & GlobalHotKeysGrid.Rows[r].Text & "'\""
          Print #xbindkeysFile, GlobalHotKeysGrid[R, C].text
          Print #xbindkeysFile, "\n"
        Endif
      Next 'r
    Next 'c
    Close #xbindkeysFile
End

Public Sub LoadHotKeys(ProfileName As String)
  Dim filename As String = ProfileName & ".profile/" & "HotKeys.txt"
  Dim Globalfilename As String = ProfileName & ".profile/" & "GlobalHotKeys.txt"
  Dim xbindkeysfilename As String = ProfileName & ".profile/" & "xbindkeysrc"
  Dim HotFile As File
  Dim GlobalHotFile As File
  
  Dim C, R, w1, w2 As Integer
  
  DefaultFill()
  
  'Local Hotkeys
  If Exist(filename) Then 
    If Stat(filename, True).size > 0 Then
        HotFile = Open filename For Read
        For c = 0 To HotKeysGrid.Columns.Count - 1
          For r = 0 To HotKeysGrid.Rows.Count - 1
            HotKeysGrid[R, C].text = Read #HotFile As String
            'Expand the column
            w1 = HotKeysGrid.Columns[c].width
            ' [GB2:FNTW] w2 = HotKeysGrid.Font.TextWidth(HotKeysGrid[r, c].Text)
            w2 = HotKeysGrid.Font.TextWidth(HotKeysGrid[r, c].Text)
            If w1 < w2 Then
              HotKeysGrid.Columns[c].width = w2 + 8
            Endif
          Next 'r
        Next 'c
        Close #HotFile
    Endif
  Endif
  
  'Global Hotkeys grid:
   If Exist(filename) Then 
    If Stat(filename, True).size > 0 Then
      GlobalHotFile = Open Globalfilename For Read
      For c = 0 To GlobalHotKeysGrid.Columns.Count - 1
        For r = 0 To GlobalHotKeysGrid.Rows.Count - 1
          GlobalHotKeysGrid[R, C].text = Read #GlobalHotFile As String
          'Expand the column
          w1 = GlobalHotKeysGrid.Columns[c].width
          ' [GB2:FNTW] w2 = GlobalHotKeysGrid.Font.TextWidth(GlobalHotKeysGrid[r, c].Text)
          w2 = GlobalHotKeysGrid.Font.TextWidth(GlobalHotKeysGrid[r, c].Text)
          If w1 < w2 Then
            GlobalHotKeysGrid.Columns[c].width = w2 + 8
          Endif
        Next 'r
      Next 'c
      Close #GlobalHotFile
    Endif
   Endif
    RestartXbindKeys(xbindkeysfilename)
End

Public Sub RestartXbindKeys(xbindkeysfilename As String)
  If FMain.closing Then Return
  Debug "Hotkeys: RestartXbindKeys()"
  Debug
    Try xbindkeys.Kill
    If Stat(xbindkeysfilename).Size > 0 Then
      xbindkeys = Shell Global.XbindkeysBIN & " -n -f " & xbindkeysfilename For Read As "xbindkeys"
    Endif
End


' PUBLIC SUB ApplyBTN_Click()
'   TRY SaveHotKeys("/tmp/hotkeys.txt")
'   TRY LoadHotKeys("/tmp/hotkeys.txt")
' END

Public Sub ApplyBTN_Click()
  Dim tmpfile As String = Temp("HotKeys.txt")
  Try SaveHotKeys(tmpfile)
  Try LoadHotKeys(tmpfile)
End

Public Sub OkBTN_Click()
  Me.HIDE
End

Public Function ActionRelatedTo(Hotkey As String) As String
'will find the cell containing 'Hotkey' in Hotkeys grid
'will return the related action
  Dim c, r As Integer

  If FMain.timerdvd.enabled Then
    If Lower(Split(Hotkey, " ")[0]) = "mouse=1" Then Return "dvdnav select"
  Endif
  If hotkey = "" Then Return "Nope"
    For c = 0 To HotKeysGrid.Columns.Count - 1
      For r = 0 To HotKeysGrid.Rows.Count - 1
        If (HotKeysGrid[r, c].text = Hotkey) Then Return HotKeysGrid.Rows[r].text
      Next 'r
    Next 'c
  Return "Nope" 'no hotkey found
End




Public Sub MenuSaveDefault_Click()
  Try HotKeys.SaveHotKeys(global.confpath & "/" & Global.CurrentProfile)
End


Public Sub MenuSaveToAll_Click()
Dim profilename, profilenamesplitted As String
  If MyQuestion.Ask(("This will save this window settings\n to all profiles found but the 'Factory_defaults' one"), ("Proceed"), ("Don't")) = 2 Then
    Return
      Else
     For Each profilename In Dir(global.confpath & "/", "*.profile")
        If Stat(global.confpath & "/" & profilename, True).type = gb.Directory Then
          profilenamesplitted = Split(profilename, ".")[0]
          If profilenamesplitted <> "Factory_Defaults" Then
            Try HotKeys.SaveHotKeys(global.confpath & "/" & profilenamesplitted)
          Endif
        Endif
     Next 'profilename
  Endif
End

Public Sub MenuLoadDefault_Click()
  Try HotKeys.LoadHotKeys(global.confpath & "/" & Global.CurrentProfile)
  Alreadyloaded = True
End

Public Sub Button1_Click()
  DefaultFill()
End

Public Sub Button2_Click()
  Dim r, c As Integer
  For r = 0 To HotKeysGrid.Rows.Count - 1
    For c = 0 To HotKeysGrid.columns.Count - 1
        HotKeysGrid[r, c].text = ""
    Next 'c
  Next 'r
End

Public Sub Button3_Click()
  Dim r, c As Integer
  For r = 0 To HotKeysGrid.Rows.Count - 1
    For c = 0 To HotKeysGrid.columns.Count - 1
      If Trim(HotKeysGrid[r, c].text) <> "" Then
        Print "HotKeysGrid[" & r & " , " & c & "].text = " & "\"" & HotKeysGrid[r, c].text & "\""
      Endif
    Next 'c
  Next 'r
End


Public Sub GlobalHotKeysGrid_DblClick()
  Dim PointedRow As Integer = GlobalHotKeysGrid.row
  Dim PointedCol As Integer = GlobalHotKeysGrid.Column
  Dim GrabbedData As String
  Dim w1, w2 As Integer = 0
  Dim profilename As String
  
  If MouseInsideGrid(GlobalHotKeysGrid) Then
    GlobalHotKeysGrid.mouse = Mouse.wait
    Try xbindkeys.Kill
    GrabbedData = GlobalGrab()
    GlobalHotKeysGrid.mouse = Mouse.Default
    If Not (GrabbedData Like "*bind*") Then
      If CheckDuplicate(GrabbedData, GlobalHotKeysGrid.row, GlobalHotKeysGrid.Column, GlobalHotKeysGrid) Then
        GlobalHotKeysGrid[pointedrow, PointedCol].Text = GrabbedData
      Endif
    Endif
   
    'Expand the column
    w1 = GlobalHotKeysGrid.Columns[PointedCol].width
    ' [GB2:FNTW] w2 = GlobalHotKeysGrid.Font.TextWidth(GlobalHotKeysGrid[pointedrow, PointedCol].Text)
    w2 = GlobalHotKeysGrid.Font.TextWidth(GlobalHotKeysGrid[pointedrow, PointedCol].Text)
    If w1 < w2 Then
      GlobalHotKeysGrid.Columns[PointedCol].width = w2 + 8
    Endif
  Endif
  
  'refresh current xbindkeys process and make it use a temporary profile,
  'so, first dump temporary global hotkeys to a temporary file
  Profilename = global.confpath & "/" & Global.CurrentProfile
  UpdateXbindKeysConfigurationFile(ProfileName & ".profile/" & "xbindkeysrc.tmp")
  RestartXbindKeys(ProfileName & ".profile/" & "xbindkeysrc.tmp")
End

Public Sub GlobalHotKeysGrid_KeyPress()
  Dim PointedRow As Integer = GlobalHotKeysGrid.row
  Dim PointedCol As Integer = GlobalHotKeysGrid.Column
  Dim profilename As String
  If Key.code = Key.delete Then
    GlobalHotKeysGrid[pointedrow, PointedCol].text = ""
    'refresh current xbindkeys process and make it use a temporary profile,
    'so, first dump temporary global hotkeys to a temporary file
    Try xbindkeys.Kill
    Profilename = global.confpath & "/" & Global.CurrentProfile
    UpdateXbindKeysConfigurationFile(ProfileName & ".profile/" & "xbindkeysrc.tmp")
    RestartXbindKeys(ProfileName & ".profile/" & "xbindkeysrc.tmp")
  Endif

End

Public Sub Button4_Click()
  Dim r, c As Integer
  For r = 0 To GlobalHotKeysGrid.Rows.Count - 1
    For c = 0 To GlobalHotKeysGrid.columns.Count - 1
        GlobalHotKeysGrid[r, c].text = ""
    Next 'c
  Next 'r
End

Public Sub Form_Close()

  If FMain.mplayer.ProcessRunningOvr() Then FMain.VideoBox.setfocus()

End

Public Sub Form_Hide()

  If FMain.mplayer.ProcessRunningOvr() Then FMain.VideoBox.setfocus()

End

Public Sub SaveBTN_Click()

   Try HotKeys.SaveHotKeys(global.confpath & "/" & Global.CurrentProfile)

End



Public Sub Form_Show()
  Try Object.SetProperty(HotKeysGrid, "ShowCursor", True)
  HotKeysGrid.Rows.H = CInt(HotKeysGrid.Font.TextHeight("Ij|") * 1.5)
  GlobalHotKeysGrid.H = CInt(GlobalHotKeysGrid.Font.TextHeight("Ij|") * 1.5)
End
